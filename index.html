<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Resource Timing Level 1</title>
  <script src='//www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
  <script class='remove'>
  var respecConfig = {
    shortName: "resource-timing-1",
    specStatus: "ED",
    useExperimentalStyles: true,
    edDraftURI: "https://w3c.github.io/resource-timing/",
    editors: [{
      name: "Arvind Jain",
      mailto: "arvind@google.com",
      company: "Google Inc.",
      note: "Until December 2014",
      w3cid: "45188"
    }, {
        name: "Todd Reifsteck",
        mailto: "toddreif@microsoft.com",
        company: "Microsoft Corp.",
        w3cid: "76565"
    }, {
      name: "Jatinder Mann",
      mailto: "jmann@microsoft.com",
      company: "Microsoft Corp.",
      note: "Until February 2014",
      w3cid: "44357"
    }, {
      name: "Zhiheng Wang",
      company: "Google Inc.",
      note: "Until July 2012",
      w3cid: "43685"
    }, {
      name: "Anderson Quach",
      company: "Microsoft Corp.",
      note: "Until March 2011",
      w3cid: "45288"
    }],
    wg: "Web Performance Working Group",
    wgURI: "https://www.w3.org/webperf/",
    license: 'w3c-software-doc',
    wgPublicList: "public-web-perf",
    subjectPrefix: "[ResourceTiming]",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/resource-timing/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/resource-timing/issues'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/resource-timing/commits/gh-pages/index.html'
      }]
    },{
      key: 'Mailing list',
      data: [{
        value: 'public-web-perf@w3.org',
        href: 'https://lists.w3.org/Archives/Public/public-web-perf/'
      }]
    },{
      key: 'Implementation',
      data: [{
        value: 'Can I use Resource Timing?',
        href: 'http://caniuse.com/#feat=resource-timing'
      }, {
        value: 'Test Suite',
        href: 'http://w3c-test.org/resource-timing/'
      }, {
        value: 'Test Suite repository',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/resource-timing'
      }]
    }],
    wgPatentURI:  "https://www.w3.org/2004/01/pp-impl/45211/status"
  };
  </script>
</head>

<body>
<section id="abstract">

<p>This specification defines an interface for web applications to access
the complete timing information for resources in a document.</p>
</section>

<section id="sotd">

<p>Implementers are encouraged to look at the latest version of <a href='https://www.w3.org/TR/resource-timing/'>Resource Timing</a> before implementing this Candidate Recommendation.</p>
<p>This specification uses <a href="https://www.w3.org/TR/hr-time/#domhighrestimestamp">DOMHighResTimeStamp</a> and <a href='https://www.w3.org/TR/hr-time-2/#time-origin'>time origin</a> from  High Resolution Time Level 2 [[HR-TIME-2]]. These were also defined in <a href="https://www.w3.org/TR/hr-time-1/">High Resolution Time Level 1</a> but Level 2 provides more refined definitions.</p>
</section>
<section id="introduction" class='informative'>
<h2>Introduction</h2>
<p>
User latency is an important quality benchmark for Web Applications. While
JavaScript-based mechanisms can provide comprehensive instrumentation for
user latency measurements within an application, in many cases, they are
unable to provide a complete end-to-end latency picture. This document introduces the <a>PerformanceResourceTiming</a>
interface to allow JavaScript mechanisms to collect complete timing
information related to resources on a document. Navigation Timing 2 [[NAVIGATION-TIMING-2]] extends this specification to provide additional timing information associated with a navigation.
</p>


<p>For example, the following JavaScript shows a simple attempt to
measure the time it takes to fetch a resource:</p>

<pre class='example highlight'>
&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body onload="loadResources()"&gt;
    &lt;script&gt;
        function loadResources()
        {
           var start = new Date().getTime();
           var image1 = new Image();
           var resourceTiming = function() {
               var now = new Date().getTime();
               var latency = now - start;
               alert("End to end resource fetch: " + latency);
           };

           image1.onload = resourceTiming;
           image1.src = 'https://www.w3.org/Icons/w3c_main.png';
        }
    &lt;/script&gt;
    &lt;img src="https://www.w3.org/Icons/w3c_home.png"&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

<p>Though this script can measure the time it takes to fetch a resource,
it cannot break down the time spent in various phases. Further, the script
cannot easily measure the time it takes to fetch resources described in markup.</p>

<p>To address the need for complete information on user experience, this document
introduces the <a>PerformanceResourceTiming</a> interface.
This interface allows JavaScript mechanisms to provide complete client-side latency measurements within applications.
With this interface, the previous example can be modified to measure a user's
perceived load time of a resource.
</p>

<p>The following script calculates the amount of time it takes to fetch every resource in the
page, even those defined in markup. This example assumes
that this page is hosted on https://www.w3.org.
One could further measure the amount of time it takes in every phase of fetching a resource
with the <a>PerformanceResourceTiming</a> interface.
</p>
<pre class='example highlight'>
&lt;!doctype html&gt;
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body onload="loadResources()"&gt;
    &lt;script&gt;
       function loadResources()
       {
          var image1 = new Image();
          image1.onload = resourceTiming;
          image1.src = 'https://www.w3.org/Icons/w3c_main.png';
       }

       function resourceTiming()
       {
           var resourceList = window.performance.getEntriesByType("resource");
           for (i = 0; i &lt; resourceList.length; i++)
           {
              if (resourceList[i].initiatorType == "img")
              {
                 alert("End to end resource fetch: "+ resourceList[i].responseEnd - resourceList[i].startTime);
              }
           }
       }
    &lt;/script&gt;
    &lt;img id="image0" src="https://www.w3.org/Icons/w3c_home.png"&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>

</section>

<section  id="conformance">

<p>Requirements phrased in the imperative as part of algorithms (such as
"strip any leading space characters" or "return false and abort these steps")
are to be interpreted with the meaning of the key word ("MUST", "SHOULD",
"MAY", etc) used in introducing the algorithm. </p>

<p>Some conformance requirements are phrased as requirements on attributes,
methods or objects. Such requirements are to be interpreted as requirements
on user agents. </p>

<p>Conformance requirements phrased as algorithms or specific steps may be
implemented in any manner, so long as the end result is equivalent. (In
particular, the algorithms defined in this specification are intended to be
easy to follow, and not intended to be performant.) </p>

    <p>The IDL fragments in this specification must be interpreted as
    required for <a href='https://www.w3.org/TR/WebIDL/#dfn-conforming-idl-fragment'>conforming IDL fragments</a>, as described in the Web IDL
    specification. [[!WebIDL]]</p>
</section>
<section id="terminology">
<h2>Terminology</h2>

<p>The construction "a <code title="">Foo</code> object", where <code
title="">Foo</code> is actually an interface, is sometimes used instead of
the more accurate "an object implementing the interface <code
title="">Foo</code>". </p>

<p>The term <dfn>DOM</dfn> is used to refer to the API set made available to scripts in
Web applications, and does not necessarily imply the existence of an actual
<code>Document</code> object or of any other <code>Node</code> objects as
defined in the DOM specification. [[DOM]]
</p>

<p>A DOM attribute is said to be <dfn>getting</dfn> when its value is being
retrieved (such as by author script), and is said to be <dfn>setting</dfn> when
a new value is assigned to it.</p>

<p>The term <dfn>JavaScript</dfn> is used to refer to ECMA262, rather than the
official term ECMAScript, since the term JavaScript is more widely known. [[ECMA-262]]
</p>

<p>The term <dfn>resource</dfn> is used to refer to elements and any other user-initiated fetches throughout this specification.
For example, a resource could originate from XMLHttpRequest objects [[XMLHttpRequest], HTML elements [[HTML5]] such as iframe, img, script, object, embed, and link with the link type of stylesheet, and SVG elements [[SVG11]] such as svg.
</p>

<p>
  The term <dfn>cross-origin</dfn> is used to mean non
  <a href="https://tools.ietf.org/html/rfc6454#section-5">same origin</a>.
</p>
<p>
  The term <dfn>current document</dfn> refers to the document associated with the <a href="https://www.w3.org/TR/html5/browsers.html#dom-document-0">Window object's newest Document object</a>.
</p>
<p>
  Throughout this work, all time values are measured in milliseconds since the start of
  navigation of the document [[!HR-TIME-2]]. For example, the <a href='https://www.w3.org/TR/navigation-timing-2/#widl-PerformanceNavigationTiming-startTime'>start of navigation of the document</a>
  occurs at time 0.
</p>
<p>
  The term <dfn>current time</dfn> refers to the number of milliseconds
  since the start of navigation of the document until the current moment in time.
</p>
<p class='note'>
  This definition of time is based on the High Resolution Time specification
  [[HR-TIME-2]] and is different
  from the definition of time used in the Navigation Timing specification
  [[NAVIGATION-TIMING]],
  where time is measured in milliseconds since midnight of January 1, 1970 (UTC).
</p>
</section>

<section id="resource-timing">
<h2>Resource Timing</h2>


<section id="introduction-1" class='informative'>
<h3>Introduction</h3>

<p>
    The <a>PerformanceResourceTiming</a>
    interface facilitates timing measurement of downloadable resources. For example, this interface is available for
    <a href="https://www.w3.org/TR/XMLHttpRequest/#interface-xmlhttprequest">XMLHttpRequest</a> objects [[XMLHttpRequest]], HTML
    elements [[HTML5]] such as
    <a href="https://www.w3.org/TR/html5/embedded-content-0.html#the-iframe-element">iframe</a>,
    <a href="https://www.w3.org/TR/html5/embedded-content-0.html#the-img-element">img</a>,
    <a href="https://www.w3.org/TR/html5/scripting-1.html#the-script-element">script</a>,
    <a href="https://www.w3.org/TR/html5/embedded-content-0.html#the-object-element">object</a>,
    <a href="https://www.w3.org/TR/html5/embedded-content-0.html#the-embed-element">embed</a>,
    and <a href="https://www.w3.org/TR/html5/document-metadata.html#the-link-element">link</a>
    with the link type of
    <a href="https://www.w3.org/TR/html5/links.html#link-type-stylesheet">stylesheet</a>,
    and SVG elements [[SVG11]] such
    as <a href="https://www.w3.org/TR/SVG11/struct.html#SVGElement">svg</a>.
</p>

</section>

<section id="resources-included">
<h3>Resources Included in the <a>PerformanceResourceTiming</a> Interface</h3>

<p>All resources <a title='fetch' href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetched</a> by the current <a href="https://www.w3.org/TR/html5/browsers.html#browsing-context">browsing</a> [[!HTML5]] or worker [[!WORKERS]] context's MUST be included as <a>PerformanceResourceTiming</a> objects in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> of the relevant context, without violating the <a href='https://tools.ietf.org/html/rfc6454#section-3.4'>origin policy</a>. Resources that are retrieved from <a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant application caches</a> or local resources MUST be included as <a>PerformanceResourceTiming</a> objects in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> [[!PERFORMANCE-TIMELINE]].</p>

<p>Aborted requests or requests that don't return a response MAY be included as <a>PerformanceResourceTiming</a> objects in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> of the relevant context.</p>

<p class='note'>
Future versions of this specification could require the inclusion of aborted requests or requests that don't return a response (see <a href="https://github.com/w3c/resource-timing/issues/12">issue 12</a>).
</p>

<p class='note'>
  Implementers should be aware of <a href='https://github.com/w3c/resource-timing/issues/27'>Issue 27: Same-origin policy &amp; observing no-cors fetches</a>.
</p>

<p>The rest of this section is non-normative.</p>
<p>
    Examples:</p>
    <ul>
        <li>If the same canonical URL is used as the <code>src</code> attribute of two HTML <code>IMG</code> elements,
            the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource initiated by the first HTML <code>IMG</code> element SHOULD
			be included as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
			The user agent might not re-request the URL for the second HTML <code>IMG</code> element, instead using the existing download it initiated for the first HTML <code>IMG</code> element.
            In this case, the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource by the first
            <code>IMG</code> element would be the only occurrence in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
        </li>
        <li>If the <code>src</code> attribute of a HTML <code>IMG</code> element is changed via script, both the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the original resource as well
            as the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the new URL would be included as <a>PerformanceResourceTiming</a> objects in
			the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
        </li>
		<li>
			If an HTML <code>IFRAME</code> element is added via markup without specifying a <code>src</code> attribute, the user agent may load the <code>about:blank</code> document for the <code>IFRAME</code>. If at a later time the <code>src</code> attribute is changed dynamically via script, the user agent may
			<a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> the new URL resource for the <code>IFRAME</code>. In this case, only the
			<a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the new URL would be included
			as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
		</li>
        <li>
            If an <code>XMLHttpRequest</code> is generated twice for the same canonical URL, both <a title='fetch' href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetches</a> of the resource would be
            included as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
			This is because the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource for the second <code>XMLHttpRequest</code> cannot reuse the download issued for the first <code>XMLHttpRequest</code>.
        </li>
        <li>
            If an HTML <code>IFRAME</code> element is included on the page, then only the resource requested by <code>IFRAME</code> <code>src</code> attribute is included
            as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
			Sub-resources requested by the <code>IFRAME</code> document will be included in the <code>IFRAME</code> document's <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> and not the parent
            document's <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
        </li>
        <li>
            If an HTML <code>IMG</code> element has a <code><a href="https://tools.ietf.org/html/rfc2397">data: URI</a></code> as its source [[!RFC2397]], then this resource will not
            be included as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
			By definition <code><a href="https://tools.ietf.org/html/rfc2397">data: URI</a></code> contains embedded data and does not require a <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a>.
        </li>
        <li>
          If a resource <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> was aborted due to a networking error (e.g. DNS, TCP, or TLS error), then the fetch would be included as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> with initialized attribute values up to the point of failure - e.g. a TCP handshake error should report DNS timestamps for the request, and so on.
        </li>
        <li>
          If a resource <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> is aborted because it failed a fetch precondition (e.g. mixed content, CORS restriction, CSP policy, etc), then this resource will not be included as a <a>PerformanceResourceTiming</a> object in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
        </li>
    </ul>
</section>

<section id="performanceresourcetiming">
<h3>The <code>PerformanceResourceTiming</code> Interface</h3>

<p>
The <dfn>PerformanceResourceTiming</dfn> interface participates in the
	<a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> and extends the following attributes of the
<a href="https://www.w3.org/TR/performance-timeline/#performanceentry">PerformanceEntry</a> interface:</p>

<dl class='attributes'>
<dt id='widl-PerformanceResourceTiming-name'><code>name</code></dt>
    <dd>
    	This attribute MUST return the <a href="https://www.w3.org/TR/html5/infrastructure.html#resolve-a-url">resolved URL</a> of the
    	requested resource. This attribute MUST NOT change even if the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> redirected to a different URL.
   	</dd>
<dt id='widl-PerformanceResourceTiming-entryType'><code>entryType</code></dt>
<dd>The <code id="entryType-attribute">entryType</code> attribute MUST return the DOMString "<code id="perf-resource">resource</code>".</dd>
<dt id='widl-PerformanceResourceTiming-startTime'><code>startTime</code></dt>
<dd>The <code id="startTime-attribute">startTime</code> attribute MUST return a <a href="https://www.w3.org/TR/hr-time/#domhighrestimestamp">DOMHighResTimeStamp</a> [[!HR-TIME-2]]
  with the time immediately before the user agent starts to queue the resource for <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching</a>.
       If there are HTTP redirects or <a href="https://www.w3.org/TR/html5/infrastructure.html#concept-http-equivalent-codes" title='HTTP response codes equivalence'>equivalent</a>
       when fetching the resource, and if all the redirects or equivalent are from the <a href="https://tools.ietf.org/html/rfc6454#section-5">same origin</a> as the current
       document or the <a>timing allow check</a> algorithm passes, this attribute MUST return the same value as <a for="PerformanceResourceTiming">redirectStart</a>.
     Otherwise, this attribute MUST return the same value as <a for="PerformanceResourceTiming">fetchStart</a>.</dd>
<dt id='widl-PerformanceResourceTiming-duration'><code>duration</code></dt>
<dd>The <code id="duration-attribute">duration</code> attribute MUST return a <a href="https://www.w3.org/TR/hr-time/#domhighrestimestamp">DOMHighResTimeStamp</a>
  equal to the difference between <a for="PerformanceResourceTiming">responseEnd</a> and <a href="#startTime-attribute">startTime</a>, respectively.</dd>
</dl>

<pre class='idl'>
[Exposed=(Window)]
interface PerformanceResourceTiming : PerformanceEntry {
    readonly        attribute DOMString           initiatorType;
    readonly        attribute DOMHighResTimeStamp redirectStart;
    readonly        attribute DOMHighResTimeStamp redirectEnd;
    readonly        attribute DOMHighResTimeStamp fetchStart;
    readonly        attribute DOMHighResTimeStamp domainLookupStart;
    readonly        attribute DOMHighResTimeStamp domainLookupEnd;
    readonly        attribute DOMHighResTimeStamp connectStart;
    readonly        attribute DOMHighResTimeStamp connectEnd;
    readonly        attribute DOMHighResTimeStamp secureConnectionStart;
    readonly        attribute DOMHighResTimeStamp requestStart;
    readonly        attribute DOMHighResTimeStamp responseStart;
    readonly        attribute DOMHighResTimeStamp responseEnd;
    serializer = {inherit, attribute};
};
</pre>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>initiatorType</dfn> attribute MUST return one of the following <code>DOMString</code>:
</p>
<ul>
<li>The same value as the <code><a href="https://www.w3.org/TR/dom/#concept-element-local-name">localName</a></code> of that
<code><a href="https://www.w3.org/TR/dom/#concept-element">element</a></code> [[!DOM]], if the initiator is an <code><a href="https://www.w3.org/TR/dom/#concept-element">element</a></code>.</li>
<li><dfn id='css-resource'><code>"css"</code></dfn>, if the initiator is a CSS resource downloaded by the <code><a href="https://www.w3.org/TR/css-syntax-3/#consume-a-url-token">url()</a></code> syntax [[!CSS-SYNTAX-3]], such as <code>@import url()</code> or <code>background: url()</code>.</li>
<li><dfn id='xhr-resource'><code>"xmlhttprequest"</code></dfn>, if the initiator is an XMLHttpRequest object [[!XMLHttpRequest]].</li>
</ul>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>redirectStart</dfn> attribute MUST return as follows:
</p>
<ol class='algorithm'>
<li>
The time immediately before the user agent starts to <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> the resource that initiates the redirect, if there are HTTP redirects or <a href="https://www.w3.org/TR/html5/infrastructure.html#concept-http-equivalent-codes" title='HTTP response codes equivalence'>equivalent</a>
when <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching</a> the resource and <strong>all</strong> the redirects or equivalent pass the <a>timing allow check</a> algorithm.
</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>redirectEnd</dfn> attribute MUST return as follows:
</p>
<ol class='algorithm'>
<li>The time immediately after receiving the last byte of the response of the last redirect, if there are HTTP redirects or <a href="https://www.w3.org/TR/html5/infrastructure.html#concept-http-equivalent-codes" title='HTTP response codes equivalence'>equivalent</a>
when <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching</a> the resource and <strong>all</strong> the redirects or equivalent pass the <a>timing allow check</a> algorithm.</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>fetchStart</dfn> attribute MUST return as follows:
</p>
<ol class='algorithm'>
<li>
The time immediately before the user agent starts to <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> the <em>final</em> resource in the redirection, if there are HTTP redirects or <a href="https://www.w3.org/TR/html5/infrastructure.html#concept-http-equivalent-codes" title='HTTP response codes equivalence'>equivalent</a>.
</li>
<li>The time immediately before the user agent starts to <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> the resource otherwise.
</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>domainLookupStart</dfn> attribute MUST return as follows:
</p>
<ol class='algorithm'>
<li>The same
value as <a for="PerformanceResourceTiming">fetchStart</a>, if a <a href="https://tools.ietf.org/html/rfc7230#section-6.3">persistent
connection</a> [[!RFC7230]] is used or the resource
is retrieved from <a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant
application caches</a> or local resources.</li>
<li>The time immediately after the user agent before the domain data retrieval from the domain information cache, if the user agent has the domain information in cache.</li>
<li>The time immediately before the user agent starts the domain name lookup for the resource, if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>domainLookupEnd</dfn> attribute MUST return as follows:
</p>
<ol class='algorithm'>
<li>The same
value as <a for="PerformanceResourceTiming">fetchStart</a>, if a <a href="https://tools.ietf.org/html/rfc7230#section-6.3">persistent
connection</a> [[!RFC7230]] is used or the resource
is retrieved from <a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant
application caches</a> or local resources.</li>
<li>The time immediately after the user agent ends the domain data retrieval from the domain information cache, if the user agent has the domain information in cache.</li>
<li>The time immediately before the user agent finishes the domain name lookup for the resource, if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>connectStart</dfn> attribute MUST return as follows:
</p>
<ol class="algorithm">
<li>The same value as <a for="PerformanceResourceTiming">fetchStart</a>, if a <a href="https://tools.ietf.org/html/rfc7230#section-6.3">persistent
connection</a> [[!RFC7230]] is used or the resource is retrieved from <a
href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache" title='relevant application cache'>relevant application caches</a> or local resources.</li>
<li>The time immediately before the user agent start establishing the connection to the server to retrieve the resource, if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.
<p>If the transport connection fails and the user agent reopens a connection,
<a for='PerformanceResourceTiming'>connectStart</a> SHOULD return the corresponding value of the new connection.</p></li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>connectEnd</dfn> attribute MUST return as follows:
</p>
<ol class="algorithm">
<li>The same value as <a for="PerformanceResourceTiming">fetchStart</a>, if a <a href="https://tools.ietf.org/html/rfc7230#section-6.3">persistent connection</a> [[!RFC7230]] is used or the resource is retrieved from <a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant application caches</a> or local resources.</li>
<li>The time immediately after the user agent start establishing the connection to the server to retrieve the resource, if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.
<p>The returned time MUST include the time interval to establish the transport connection, as well as other time intervals such as SSL handshake and SOCKS authentication.</p>
<p>If the transport connection fails and the user agent reopens a connection, <a for='PerformanceResourceTiming'>connectEnd</a> SHOULD return the corresponding value of the new connection.</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
 The <dfn>secureConnectionStart</dfn> attribute is optional. On getting, the attribute MUST return as follows:
</p>
<ol class="algorithm">
<li>The same value as <a for="PerformanceResourceTiming">fetchStart</a>, if a <a href="https://tools.ietf.org/html/rfc7230#section-6.3">persistent connection</a> [[!RFC7230]] is used or the resource is retrieved from <a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant application caches</a> or local resources.</li>
<li>The time immediately before the user agent starts the handshake process to secure the current connection, if a secure transport is used and the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.</li>
</ul>
</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>requestStart</dfn> attribute MUST return as follows:
</p>
<ol class="algorithm">
<li>The time immediately before the user agent
starts requesting the resource from the server, or from
<a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">
relevant application caches</a> or from local resources, if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.
<p>If the transport connection fails after a request is sent and the user
agent reopens a connection and resend the request, <a for='PerformanceResourceTiming'>requestStart</a> MUST return the corresponding values of the new request.</p>
</li>
<li>zero, otherwise.</li>
</ol>

<aside class="note">
<p>This interface does not include an attribute to represent the completion of
sending the request, e.g. <dfn><code>requestEnd</code></dfn>.</p>
<ul>
<li>Completion of sending the request from the user agent does not always
indicate the corresponding completion time in the network transport, which
brings most of the benefit of having such an attribute.</li>
<li>Some user agents have high cost to determine the actual completion time of
sending the request due to the HTTP layer encapsulation.</li>
</ul>
</aside>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>responseStart</dfn> attribute MUST return as follows:
</p>
<ol class="algorithm">
<li>
The time immediately after the user agent receives the first byte of the response from <a
href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant application caches</a>, or from local resources or from the server if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.
</li>
<li>zero, otherwise.</li>
</ol>

<p dfn-for='PerformanceResourceTiming'>
On getting, the <dfn>responseEnd</dfn> attribute MUST return as follows:
</p>
<ol class="algorithm">
<li>
The time immediately after the user agent receives the last byte of the response or immediately before the transport connection is closed, whichever comes first. The resource here can be received either from <a
href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">relevant application caches</a>, or from local resources or from the server if the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource passes the <a>timing allow check</a> algorithm.
</li>
<li>zero, otherwise.</li>
</ol>

</section>

<section id="extensions-performance-interface">
<h3>Extensions to the <code>Performance</code> Interface</h3>

<p>
    The user agent MAY choose to limit how many resources are included as
    <a>PerformanceResourceTiming</a> objects in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a> [[!PERFORMANCE-TIMELINE]]. This section extends the <a href="https://www.w3.org/TR/performance-timeline/#dom-performance"><code>Performance</code></a> interface to allow controls over the number of <a>PerformanceResourceTiming</a> objects stored.</p>
<p>
  The recommended minimum number of <a>PerformanceResourceTiming</a> objects is 150, though this may be changed by the user agent.
    <a for="Performance">setResourceTimingBufferSize</a>
    can be called to request a change to this limit.
</p>

<p>Each <a href='https://www.w3.org/TR/WebIDL-1/#h-es-environment'>ECMAScript global environment</a> has:</p>
<ul>
  <li>a <dfn>resource timing buffer size limit</dfn> which should initially be 150 or greater.</li>
  <li>a <dfn>resource timing buffer current size</dfn> which is initially 0.</li>
  <li>a <dfn>resource timing buffer full flag</dfn> which is initially false.</li>
  <li>a <dfn>performance entry buffer</dfn> to store <a href="https://www.w3.org/TR/performance-timeline/#performanceentry">PerformanceEntry</a> objects. It is initially empty.
  <p class='note'>
  This buffer is the same one as the  performance entry buffer defined in [[PERFORMANCE-TIMELINE-2]].</p></li>
</ul>

<pre class="idl">partial interface Performance {
  void clearResourceTimings ();
  void setResourceTimingBufferSize (unsigned long maxSize);
              attribute EventHandler onresourcetimingbufferfull;
};</pre>
<p>
  The <code><dfn data-cite="!HR-TIME-2#performance">Performance</dfn></code> object 
  is defined in [[!HR-TIME-2]].
</p>

<p>
  The method <dfn for='Performance'>clearResourceTimings</dfn> runs the following steps:
</p>
<ol>
  <li>remove all <a>PerformanceResourceTiming</a> objects in the <a>performance entry buffer</a>.</li>
  <li>set <a>resource timing buffer current size</a> to 0.</li>
  <li>set <a>resource timing buffer full flag</a> to false.</li>
</ol>

<p>
The <dfn for='Performance'>setResourceTimingBufferSize</dfn> method runs the following steps:</p>
<ol>
<li>
Set <a>resource timing buffer size limit</a> to the <i>maxSize</i> parameter. If the <i>maxSize</i> parameter is less than <a>resource timing buffer current size</a>, no <a>PerformanceResourceTiming</a> objects are to be removed from the <a>performance entry buffer</a>.
</li>
<li>
Set <a>resource timing buffer full flag</a> to false.
</li>
</ol>

<p>
  The attribute <dfn for='Performance'>onresourcetimingbufferfull</dfn> is the event handler for the <code>resourcetimingbufferfull</code> event.
</p>

<p>To <dfn>add a PerformanceResourceTiming entry</dfn> (<i>new entry</i>) in the <a>performance entry buffer</a>, run the following steps:</p>
<ol>
<li>If <a>resource timing buffer current size</a> is less than <a>resource timing buffer size limit</a>, run the following substeps:
<ol style='list-style-type: lower-latin;'>
<li>Add <i>new entry</i> to the <a>performance entry buffer</a>.</li>
<li>increase <a>resource timing buffer current size</a> by 1.</li>
</ol>
</li>
<li>Otherwise, if the <a>resource timing buffer full flag</a> is false, run the following substeps:
<ol style='list-style-type: lower-latin;'>
<li><a href='https://www.w3.org/TR/html5/webappapis.html#fire-a-simple-event'>fire a simple event</a> named <a for="Performance" data-lt="onresourcetimingbufferfull">resourcetimingbufferfull</a> at the Document, with its <code>bubbles</code> attribute initialized to true, and has no default action.</li>
<li>set the <a>resource timing buffer full flag</a> to true.</li>
</ol>
</li>
</ol>

</section>

<section id="cross-origin-resources">
<h3>Cross-origin Resources</h3>
    <p>
      Cross-origin resources MUST be included as <a>PerformanceResourceTiming</a> objects in the <a href="https://www.w3.org/TR/performance-timeline/#sec-performance-timeline">Performance Timeline</a>.
		If the <a>timing allow check</a> algorithm fails for a <a>cross-origin</a> resource, these attributes of its <a>PerformanceResourceTiming</a> object
		MUST be set to zero: <a for="PerformanceResourceTiming">redirectStart</a>, <a for="PerformanceResourceTiming">redirectEnd</a>,
        <a for="PerformanceResourceTiming">domainLookupStart</a>, <a for="PerformanceResourceTiming">domainLookupEnd</a>, <a for="PerformanceResourceTiming">connectStart</a>,
        <a for="PerformanceResourceTiming">connectEnd</a>, <a for="PerformanceResourceTiming">requestStart</a>, <a for="PerformanceResourceTiming">responseStart</a>, and
		 <a for="PerformanceResourceTiming">secureConnectionStart</a>.
    </p>
    <p>
        Server-side applications may return the <a>Timing-Allow-Origin</a> HTTP response header
        to allow the User Agent to fully expose, to the document origin(s) specified, the
        values of attributes that would have been zero due to the <a>cross-origin</a>
        restrictions previously specified in this section. </p>

    <section id="timing-allow-origin">
    <h4><code>Timing-Allow-Origin</code> Response Header</h4>
    <p>The <dfn id="http-timing-allow-origin"><code>Timing-Allow-Origin</code>
    </dfn> HTTP response header field can be used to communicate a policy
    indicating origin(s) that are allowed to see values of attributes that
    would have been zero due to the cross-origin restrictions. The header's
    value is represented by the following ABNF [[!RFC5234]]:</p>

    <pre class="abnf">
      Timing-Allow-Origin = 1#( <a href='https://fetch.spec.whatwg.org/#origin-header'>origin-or-null</a> / <a href='https://fetch.spec.whatwg.org/#http-new-header-syntax'>wildcard</a> )
    </pre>

    <p>The sender MAY generate multiple <a>Timing-Allow-Origin</a> header
    fields. The recipient MAY combine multiple <a>Timing-Allow-Origin</a>
    header fields by appending each subsequent field value to the combined
    field value in order, separated by a comma.</p>

    <p>The <dfn id="timing-allow-check">timing allow check</dfn> algorithm,
    which checks whether a resource's timing information can be shared with the
    <a>current document</a>, is as follows:<p>

	  <ol>
      <li><p>If the resource is same origin, return <code>pass</code>.
      <li><p>If the <a>Timing-Allow-Origin</a> header value list contains a
      case-sensitive match for the value of the <code title="http-origin">
      <a href="https://tools.ietf.org/html/rfc6454#section-4">origin</a></code>
      of the <a>current document</a>, or a wildcard ("<code>*</code>"),
      return <code>pass</code>.
      <li>Return <code>fail</code>.
    </ol>
    </section>
</section>

</section>
<section id="process">
<h2>Process</h2>

<section id="processing-model">
<h3>Processing Model</h3>

<p>The following graph illustrates the timing attributes defined by the PerformanceResourceTiming interface. Attributes underlined may not be available when <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching</a> resources from different <a href="https://tools.ietf.org/html/rfc6454#section-5">origins</a>. User agents may perform internal processing in between timings, which allow for non-normative intervals between timings.</p>

<p><img style="width:85%" src="resource-timing-overview-1.png" alt='Resource Timing attributes'></p>

<p>For each resource <a href='#resources-included'>included in the performance timelime</a>, perform the following steps:</p>

  <ol class='algorithm'>
      <li id="step-create-object">Create a new <a>PerformanceResourceTiming</a> object and
      set <a href="#entryType-attribute">entryType</a> to the DOMString <code>resource</code>.
      </li>
      <li>Immediately before the user agent starts to queue the resource for retrieval,
       record the <a>current time</a> in <a href="#startTime-attribute">startTime</a>.
      </li>
      <li>Record the initiator of the resource in <a for="PerformanceResourceTiming">initiatorType</a>.
      </li>

      <li>Record the <a href="https://www.w3.org/TR/html5/infrastructure.html#resolve-a-url">resolved URL</a> of the requested resource in <a href="#widl-PerformanceResourceTiming-name">name</a>.</li>

      <li id="step-fetch-start">Immediately before a user agent starts the <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching process</a>, record the <a>current time</a> as <a for="PerformanceResourceTiming">fetchStart</a>. Let <a for="PerformanceResourceTiming">domainLookupStart</a>, <a for="PerformanceResourceTiming">domainLookupEnd</a>, <a for="PerformanceResourceTiming">connectStart</a> and <a for="PerformanceResourceTiming">connectEnd</a> be the same value as <a for="PerformanceResourceTiming">fetchStart</a>.</li>

      <li id="step-collection-start">If the user agent is to reuse the data from another existing or completed <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> initiated from the <a>current document</a>, abort the
          remaining steps.
      </li>
      <li>If <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching</a> the resource is aborted for any reason, abort the remaining steps.       </li>
      <li>If the last non-redirected <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> of the resource fails the <a>timing allow check</a>, the user agent
      MUST set
      <a for="PerformanceResourceTiming">redirectStart</a>,
      <a for="PerformanceResourceTiming">redirectEnd</a>,
      <a for="PerformanceResourceTiming">domainLookupStart</a>,
      <a for="PerformanceResourceTiming">domainLookupEnd</a>,
      <a for="PerformanceResourceTiming">connectStart</a>,
      <a for="PerformanceResourceTiming">connectEnd</a>,
      <a for="PerformanceResourceTiming">requestStart</a>,
      <a for="PerformanceResourceTiming">responseStart</a> and
	  <a for="PerformanceResourceTiming">secureConnectionStart</a>
	  to zero and go to step <a href="#step-response-end">17</a>.
      </li>
        <li>Let <a for="PerformanceResourceTiming">domainLookupStart</a>,
       <a for="PerformanceResourceTiming">domainLookupEnd</a>,
       <a for="PerformanceResourceTiming">connectStart</a> and
       <a for="PerformanceResourceTiming">connectEnd</a> be the same value as
       <a for="PerformanceResourceTiming">fetchStart</a>.</li>
      <li>If the resource is fetched from the <a href="https://www.w3.org/TR/html5/browsers.html#relevant-application-cache">
       relevant application cache</a> or local resources, including the <a
       href="https://tools.ietf.org/html/rfc7234">HTTP cache</a> [[!RFC7234]],
     go to step <a href="#step-request-start">15</a>.
      </li>
      <li>If no domain lookup is required, go to step <a href="#step-connect-start">13</a>. Otherwise, immediately before a user agent
       starts the domain name lookup, record the time as <a for="PerformanceResourceTiming">domainLookupStart</a>.</li>
      <li>Record the time as <a for="PerformanceResourceTiming">domainLookupEnd</a> immediately after the
       domain name lookup is successfully done. A user agent may need multiple retries before that. If
       the domain lookup fails, abort the remaining steps. </li>
      <li id="step-connect-start">If a persistent transport connection is used to <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch">fetch</a> the resource,
       let <a for="PerformanceResourceTiming">connectStart</a> and <a for="PerformanceResourceTiming">connectEnd</a>
       be the same value of <a for="PerformanceResourceTiming">domainLookupEnd</a>. Otherwise, record the time as
       <a for="PerformanceResourceTiming">connectStart</a> immediately before initiating the connection to the server and record the time as <a for="PerformanceResourceTiming">connectEnd</a> immediately after the connection to the server or the proxy is established. A user agent may need multiple retries before this time. If a connection can not be established, abort the remaining steps.
      </li>
      <li>If supported, the user agent MUST set the <a for="PerformanceResourceTiming">secureConnectionStart</a> attribute as follows:
        <ol>
        <li>When a secure transport is used, the user agent MUST record the
         time as <a for="PerformanceResourceTiming">secureConnectionStart</a>
         immediately before the handshake process to secure the connection.
        </li>
        <li>When a secure transport is not used, the user agent MUST set the
        value of <a for="PerformanceResourceTiming">secureConnectionStart</a> to 0.
        </li>
        </ol>
      </li>
      <li id="step-request-start">Immediately before a user agent starts sending the request
      for the resource, record the <a>current time</a> as <a for="PerformanceResourceTiming">requestStart</a>.
      </li>
      <li id="step-response-start">Record the time as <a for="PerformanceResourceTiming">
      responseStart</a> immediately after the user agent receives the first byte of the response.
      </li>
      <li id="step-response-end">Record the time as <a for="PerformanceResourceTiming">responseEnd</a>
      immediately after receiving the last byte of the response.
      <ol>
        <li>Return to step <a href="#step-connect-start">13</a> if the user agent fails to send the request or receive the entire response, and needs to reopen the connection.

        <aside class="example">
        <p>When <a href="https://tools.ietf.org/html/rfc7230#section-6.3">persistent connection</a>
        [[!RFC7230]] is enabled, a user agent may first try to re-use an open connect to
        send the request while the connection can be <a href="https://tools.ietf.org/html/rfc7230#section-6.5">asynchronously
        closed</a>. In such case, <a for="PerformanceResourceTiming">connectStart</a>, <a for="PerformanceResourceTiming">connectEnd</a> and
        <a for="PerformanceResourceTiming">requestStart</a> SHOULD represent timing information collected over the re-open connection. </p>
        </aside></li>

      </ol>
      </li>
      <li>Record the difference between <a for="PerformanceResourceTiming">responseEnd</a> and <a href="#startTime-attribute">startTime</a> in <a href="#duration-attribute">duration</a>.</li>
      <li>If the fetched resource results in an HTTP redirect or
      <a href="https://www.w3.org/TR/html5/infrastructure.html#concept-http-equivalent-codes" title='HTTP response codes equivalence'>equivalent</a>, then
      <ol>
            <li>If the current resource and the redirected resource are not from the
             <a href="https://tools.ietf.org/html/rfc6454#section-5">same origin</a> as the <a>current document</a>,
			 and the <a>timing allow check</a> algorithm fails for either resource,
			 set <a for="PerformanceResourceTiming">
             redirectStart</a> and <a for="PerformanceResourceTiming">redirectEnd</a> to 0. Then, return to step <a href="#step-fetch-start">5</a> with the new resource.
	        </li>
            <li>If the value of redirectStart is not set, let it be the value of fetchStart.
            </li>
            <li>Let redirectEnd be the value of responseEnd.
            </li>
            <li>Set all the attributes in the <a>PerformanceResourceTiming</a> object to 0 except
             <a href="#startTime-attribute">startTime</a>,
             <a for="PerformanceResourceTiming">redirectStart</a>, <a for="PerformanceResourceTiming">
             redirectEnd</a>, and <a for="PerformanceResourceTiming">initiatorType</a>.
            </li>
            <li>Return to step <a href="#step-fetch-start">5</a> with the new resource.
            </li>
        </ol>
      </li>
      <li><a data-lt='add a PerformanceResourceTiming entry'>Add</a> the <a>PerformanceResourceTiming</a> object.
      </li>
  </ol>
</section>
<section id="monotonic-clock">
<h3>Monotonic Clock</h3>
<p>The value of the timing attributes MUST monotonically increase to ensure timing attributes are not
skewed by adjustments to the system clock while <a href="https://www.w3.org/TR/html5/infrastructure.html#fetch" title='fetch'>fetching</a> the resource. The difference between any two chronologically
recorded timing attributes MUST never be negative. For all resources, including subdocument resources, the user agent MUST
record the system clock at the beginning of the root document navigation and define subsequent timing attributes in
terms of a monotonic clock measuring time elapsed from the beginning of the navigation.
</p>
</section>
</section>

<section id="privacy-security" class='informative'>
<h2>Privacy and Security</h2>

<p>The <a>PerformanceResourceTiming</a> interface exposes timing information for a resource to any web page or worker that has requested that resource. To limit the access to the <a>PerformanceResourceTiming</a> interface, the <a href="https://tools.ietf.org/html/rfc6454#section-5">same origin</a>
policy is enforced by default and certain attributes are set to zero, as described in <a href="#cross-origin-resources"></a>. Resource providers can
explicitly allow all timing information to be collected for a resource by
adding the <a href="#timing-allow-origin">Timing-Allow-Origin</a> HTTP response header, which specifies the
domains that are allowed to access the timing information. </p>

<p>
Statistical fingerprinting is a privacy concern where a malicious web site may determine whether a user has visited a third-party web site by measuring the timing of cache hits and misses of resources in the third-party web site. Though the <a>PerformanceResourceTiming</a> interface gives timing information for resources in a document, the <a href="#cross-origin-resources">cross-origin restrictions</a> prevent making this privacy concern any worse than it is today using the load event on resources to measure timing to determine cache hits and misses.
</p>
</section>
<section class="appendix">
<h2>Acknowledgments</h2>
<p>We would like to sincerely thank Karen Anderson, Darin Fisher, Tony Gentilcore,
Nic Jansma, Kyle Scholz, Jonas Sicking, James Simonsen, Steve Souders,
Annie Sullivan, Sigbjørn Vik, Jason Weber to acknowledge their contributions to this work.</p>
</section>

</body>
</html>
